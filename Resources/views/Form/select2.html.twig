{% block select2_widget %}
    {% set field = field|default('label') %}

    <input type="hidden" name="{{ full_name }}" class="{{ class|default('') }}" value="{{ multiple ? value|default([])|pluck('id')|join(',') : value.id|default('') }}">
    <script type="text/javascript">
        $(document).ready(function() {
            $("[name='{{ full_name }}").select2({
                placeholder: "{{ 'select an option'|trans }}",
                allowClear: {{ required ? 'false' : 'true' }},
                {% if url %}
                    ajax: {
                        {% if form.parent.vars.select2 is defined %}
                            {% if form.parent.vars.select2[name].url is defined  %}
                                {% set url = form.parent.vars.select2[name].url  %}
                            {% endif %}
                        {% endif %}
                        url     : '{{ url }}',
                        dataType: 'json',
                        quietMillis: 200,
                        data: function (term, page) {
                            return {
                                q: term
                            };
                        },
                        results: function (data, page, query) {
                            return {
                                results: data
                            };
                        }
                    },
                {% else %}
                    data: {{ list_data|default([])|json_encode|raw }},
                {% endif %}
                multiple: {{ multiple ? 'true' : 'false' }},
                {% if allow_add %}
                    createSearchChoice: function (term) {
                        return { id: term, {{ field }}: term };
                    },
                {% endif %}
                formatResult: function (ob, container, query) {
                    return ob.{{ field }}
                },
                formatSelection: function(ob, container) {
                    return ob.{{ field }}
                },
                {% if value is iterable or value.id is defined %}
                    initSelection: function(el, cb) {
                        cb({{ value|json_encode|raw }})
                    }
                {% endif %}
            });
        });
    </script>
{% endblock %}
